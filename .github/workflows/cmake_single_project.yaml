name: Build and Test

on:
  workflow_dispatch:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  build-and-test:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential libsdl2-dev libsdl2-image-dev cmake ccache

    - name: Cache compiler output
      uses: actions/cache@v4
      with:
        path: ~/.ccache
        key: ${{ runner.os }}-ccache-${{ hashFiles('**/CMakeLists.txt') }}
        restore-keys: |
          ${{ runner.os }}-ccache-
          
    - name: Set up toolchain
      run: |
        cd build
        export CCACHE_DIR=$HOME/.ccache
        export CCACHE_MAXSIZE=500M
        ccache -z
        # Run cmake directly to avoid 'rm -rf CMakeFiles' inside 'set-desktop-toolchain.sh' to keep cache.
        cmake . -DGAMEBOY_ADVANCE=OFF -DCMAKE_C_COMPILER_LAUNCHER=ccache -DCMAKE_CXX_COMPILER_LAUNCHER=ccache
        
    - name: Build project
      run: |
        cd build
        export CCACHE_DIR=$HOME/.ccache
        make -j$(nproc)
        ccache -s
    
    - name: Package Linux build
      run: |
        cd build
        python3 ../tools/encode_files.py
        ./package-linux.sh
    
    - name: Run regression tests
      run: |
        cd build
        ./skyland/bin/Skyland --regression 2>&1 | tee regression.log
        last=$(tail -n1 regression.log)
        if [ "$last" != "regression success!" ]; then
          echo "regression failed â€” last line was: $last"
          exit 1
        fi
        
    
    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      if: success()
      with:
        name: skyland-linux-build
        path: build/skyland/
